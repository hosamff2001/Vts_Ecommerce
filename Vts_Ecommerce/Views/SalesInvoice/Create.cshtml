@model SalesInvoice

@{
    ViewData["Title"] = "Create Invoice";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10">
            <h2>Create New Sales Invoice</h2>
            
            <form asp-action="Create" method="post" class="mt-4" id="invoiceForm">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="alert alert-danger"></div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Invoice Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="CustomerId" class="form-label">Customer *</label>
                                    <select asp-for="CustomerId" class="form-select">
                                        <option value="">-- Select Customer --</option>
                                        @foreach (var customer in ViewBag.Customers)
                                        {
                                            <option value="@customer.Id">@customer.Name</option>
                                        }
                                    </select>
                                    <span asp-validation-for="CustomerId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="InvoiceDate" class="form-label">Invoice Date *</label>
                                    <input asp-for="InvoiceDate" class="form-control" type="date" />
                                    <span asp-validation-for="InvoiceDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Line Items</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive mb-3">
                            <table class="table table-sm" id="lineItemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Qty</th>
                                        <th>Unit Price</th>
                                        <th>Item Discount</th>
                                        <th>Line Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="lineItemsBody">
                                    <!-- Rows added dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-sm btn-success" id="addLineBtn">+ Add Line Item</button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Totals</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Subtotal:</label>
                                    <p id="subtotal">0.00</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="DiscountAmount" class="form-label">Invoice Discount</label>
                                    <input asp-for="DiscountAmount" class="form-control" type="number" step="0.01" value="0" />
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="TaxAmount" class="form-label">Tax Amount</label>
                                    <input asp-for="TaxAmount" class="form-control" type="number" step="0.01" value="0" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Grand Total:</label>
                                    <p id="grandTotal" style="font-size: 1.3em; color: #28a745;">0.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <input type="hidden" id="lineItemsJson" name="lineItemsJson" />

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Create Invoice</button>
                    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    
    <script>
        const products = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(((IEnumerable<dynamic>)ViewBag.Products).Select(p => new { id = p.Id, name = p.Name, price = p.SellingPrice }).ToList()));
        let rowCounter = 0;

        function addLineItem() {
            const tbody = document.getElementById('lineItemsBody');
            const row = document.createElement('tr');
            row.className = 'line-item-row';
            row.dataset.rowId = rowCounter;
            
            const productSelect = products.map(p => `<option value="${p.id}">${p.name} (${p.price.toFixed(2)})</option>`).join('');
            
            row.innerHTML = `
                <td>
                    <select class="form-select form-select-sm product-select" data-row="${rowCounter}">
                        <option value="">-- Select --</option>
                        ${productSelect}
                    </select>
                </td>
                <td><input type="number" class="form-control form-control-sm quantity" value="1" min="1"></td>
                <td><input type="number" class="form-control form-control-sm unit-price" step="0.01" readonly></td>
                <td><input type="number" class="form-control form-control-sm discount" value="0" step="0.01"></td>
                <td><span class="line-total">0.00</span></td>
                <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
            `;
            
            tbody.appendChild(row);
            
            // Attach event listeners
            const select = row.querySelector('.product-select');
            const quantity = row.querySelector('.quantity');
            const unitPrice = row.querySelector('.unit-price');
            const discount = row.querySelector('.discount');
            
            select.addEventListener('change', (e) => {
                const product = products.find(p => p.id == e.target.value);
                unitPrice.value = product ? product.price.toFixed(2) : '0';
                calculateLineTotal(row);
            });
            
            quantity.addEventListener('change', () => calculateLineTotal(row));
            discount.addEventListener('change', () => calculateLineTotal(row));
            
            row.querySelector('.remove-row').addEventListener('click', () => {
                row.remove();
                calculateGrandTotal();
            });
            
            rowCounter++;
            calculateGrandTotal();
        }

        function calculateLineTotal(row) {
            const qty = parseFloat(row.querySelector('.quantity').value) || 0;
            const price = parseFloat(row.querySelector('.unit-price').value) || 0;
            const discount = parseFloat(row.querySelector('.discount').value) || 0;
            const total = (qty * price) - discount;
            row.querySelector('.line-total').textContent = total.toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let subtotal = 0;
            document.querySelectorAll('.line-item-row').forEach(row => {
                subtotal += parseFloat(row.querySelector('.line-total').textContent) || 0;
            });
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            
            const invoiceDiscount = parseFloat(document.querySelector('[name="DiscountAmount"]').value) || 0;
            const tax = parseFloat(document.querySelector('[name="TaxAmount"]').value) || 0;
            const grandTotal = subtotal + tax - invoiceDiscount;
            
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
            updateLineItemsJson();
        }

        function updateLineItemsJson() {
            const lineItems = [];
            document.querySelectorAll('.line-item-row').forEach(row => {
                const productId = row.querySelector('.product-select').value;
                const qty = row.querySelector('.quantity').value;
                const price = row.querySelector('.unit-price').value;
                const discount = row.querySelector('.discount').value;
                
                if (productId) {
                    lineItems.push({
                        productId: parseInt(productId),
                        quantity: parseInt(qty),
                        unitPrice: parseFloat(price),
                        discountAmount: parseFloat(discount) || 0
                    });
                }
            });
            document.getElementById('lineItemsJson').value = JSON.stringify(lineItems);
        }

        document.getElementById('addLineBtn').addEventListener('click', addLineItem);
        document.querySelector('[name="DiscountAmount"]').addEventListener('change', calculateGrandTotal);
        document.querySelector('[name="TaxAmount"]').addEventListener('change', calculateGrandTotal);

        // Add at least one row on load
        addLineItem();
    </script>
}
